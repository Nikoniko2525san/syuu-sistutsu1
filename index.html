<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>お小遣い帳（フル機能版）</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body, html { height: 100%; margin:0; }
    .bg-video { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:-1; }
    .overlay { position:relative; z-index:1; padding:20px; background: rgba(255,255,255,0.8); min-height:100%; }
  </style>
</head>
<body>
  <!-- YouTube 背景 -->
  <div class="bg-video">
    <iframe src="https://www.youtube.com/embed/{{ youtube_id }}?autoplay=1&mute=1&loop=1&playlist={{ youtube_id }}&controls=0&showinfo=0&modestbranding=1" frameborder="0" allow="autoplay; encrypted-media" style="width:100%; height:100%;"></iframe>
  </div>

  <div class="overlay">
    <h1 class="mb-4">お小遣い支出帳</h1>

    <!-- 入力フォーム -->
    <form id="form" class="row g-3 mb-4">
      <div class="col-sm-3">
        <input type="date" id="date" class="form-control" required>
      </div>
      <div class="col-sm-4">
        <input type="text" id="item" placeholder="用途" class="form-control" required>
      </div>
      <div class="col-sm-3">
        <input type="number" id="amount" placeholder="金額" class="form-control" required>
      </div>
      <div class="col-sm-2">
        <button type="submit" class="btn btn-primary w-100">追加</button>
      </div>
    </form>

    <!-- フィルタ選択 -->
    <div class="mb-3">
      <select id="mode" class="form-select w-auto d-inline">
        <option value="all">全て</option>
        <option value="1month">1ヶ月</option>
        <option value="1week">1週間</option>
        <option value="custom">任意</option>
      </select>
      <input type="date" id="start" class="form-control d-inline w-auto" style="display:none">
      <input type="date" id="end" class="form-control d-inline w-auto" style="display:none">
      <button id="filterBtn" class="btn btn-secondary">絞り込み</button>
    </div>

    <!-- 合計表示 -->
    <h4>合計: <span id="total">0</span> 円</h4>

    <!-- グラフ -->
    <canvas id="chart"></canvas>

    <!-- 支出一覧 -->
    <table class="table mt-3">
      <thead>
        <tr><th>日付</th><th>用途</th><th>金額</th><th>削除</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- JavaScript -->
  <script>
    const api = '/api/expenses'
    const form = document.getElementById('form')
    const tbody = document.getElementById('tbody')
    const totalEl = document.getElementById('total')
    const modeEl = document.getElementById('mode')
    const startEl = document.getElementById('start')
    const endEl = document.getElementById('end')
    const filterBtn = document.getElementById('filterBtn')

    let chart

    function fetchAndRender() {
      let mode = modeEl.value
      let url = api+'?mode='+mode
      if(mode==='custom'){
        url += '&start='+startEl.value+'&end='+endEl.value
      }
      fetch(url)
        .then(r=>r.json())
        .then(data=>{
          tbody.innerHTML = ''
          let total=0
          let labels=[], sums={}
          data.forEach(e=>{
            total += e.amount
            const tr = document.createElement('tr')
            tr.innerHTML = `<td>${e.date}</td><td>${e.item}</td><td>${e.amount} 円</td><td><button class="btn btn-sm btn-danger">✕</button></td>`
            tr.querySelector('button').onclick = ()=>{
              fetch(api, {method:'DELETE',headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:e.id})})
                .then(fetchAndRender)
            }
            tbody.appendChild(tr)
            sums[e.date] = (sums[e.date]||0) + e.amount
          })
          totalEl.textContent = total

          labels = Object.keys(sums).sort()
          const ds = labels.map(d=>sums[d])
          if(chart) chart.destroy()
          const ctx = document.getElementById('chart').getContext('2d')
          chart = new Chart(ctx, {
            type: 'bar', data: {labels, datasets: [{label:'日別支出', data: ds, backgroundColor:'rgba(54,162,235,0.5)'}]}
          })
        })
    }

    form.onsubmit = e=>{
      e.preventDefault()
      fetch(api, {method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({date:date.value,item:item.value,amount:parseInt(amount.value)})})
        .then(()=>{form.reset(); fetchAndRender()})
    }

    modeEl.onchange = ()=>{
      if(modeEl.value==='custom'){
        startEl.style.display = endEl.style.display = 'inline-block'
      } else {
        startEl.style.display = endEl.style.display = 'none'
      }
    }

    filterBtn.onclick = fetchAndRender

    fetchAndRender()
  </script>
</body>
</html>
